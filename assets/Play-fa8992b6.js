var Zt=Object.defineProperty;var Yt=(e,t,n)=>t in e?Zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var z=(e,t,n)=>(Yt(e,typeof t!="symbol"?t+"":t,n),n);import{r as Xt,_ as Fe,o as y,d as I,w as b,a as E,V as mt,b as j,t as H,e as ue,f as Jt,g as W,h as en,p as gt,i as _t,c as ve,j as tn,F as nn,A as on,k as Je}from"./index-26223939.js";import{V as ze,a as te,c as ce,b as me,g as et,d as rn,f as qe,e as sn}from"./VRow-40fb1c29.js";let ae=null;function an(e){return e&&e.fen&&typeof e.fen=="string"&&typeof e.index=="number"&&typeof e.moveNumber=="number"&&e.color=="white"||e.color=="black"}async function ln(){ae==null&&(ae=await cn()),un(ae.length==1e5||ae.length==1e3,`Length is not 100000 or 1000, but ${ae.length}`);const e=Math.floor(Math.random()*ae.length),t=ae[e],n=t.split(" "),o=Number(n[5]),i=n[1]=="w"?"white":"black";return{fen:t,index:e,moveNumber:o,color:i}}async function cn(){return await(await fetch("fens/fens_created_perfect_count.json")).json()}function un(e,t){if(!e)throw new Error(t)}function dn(e){let t=0;for(;t<=e.gameResults.length;){const n=e.gameResults[e.gameResults.length-t-2];if(!n)break;if(n.attempts==1&&n.solved)t++;else break}return Math.max(0,t-1)}function fn(e){return e&&typeof e.paused=="boolean"&&typeof e.start=="object"&&typeof e.end=="object"&&typeof e.update&&Array.isArray(e.deltas)}function hn(){const e=new Date,t=new Date(e);t.setSeconds(e.getSeconds()+61.5);let n=Xt({paused:!0,start:e,end:t,update:0,deltas:[]});return n.update=setTimeout(()=>bt(n),1e3),n}function bt(e){e.paused&&e.end.setSeconds(e.end.getSeconds()+1),e.update=setTimeout(()=>bt(e),1e3)}function pn(){return{correct:0,gameResults:[],temp:{}}}function mn(e){return e&&typeof e.correct=="number"}const gn={data:()=>({color:void 0,skipInterval:null,skipMillisLeft:0}),props:{state:{required:!0,validator:e=>mn(e),type:Object},puzzle:{required:!0,validator:e=>an(e),type:Object}},emits:["skip"],methods:{skip(e){if(!e){clearInterval(this.skipMillisLeft),this.skipMillisLeft=0;return}const t=5e3,n=100;this.skipMillisLeft=t,this.skipInterval=setInterval(()=>{this.skipMillisLeft>0?this.skipMillisLeft-=n:(clearInterval(this.skipInterval),this.skipMillisLeft=0,this.$emit("skip"))},n)},input(e){const t=new Event("mousedown"),n=this.$refs.puzzleCard;if(!n||!n.$el)throw new Error("no puzzle element");const o=n.$el,i=o.getBoundingClientRect();t.clientX=i.left+i.width/2,t.clientY=i.top+i.height/2,o.dispatchEvent(t),this.color=e==="right"?"green":"red",setTimeout(()=>{o.dispatchEvent(new Event("mouseup")),this.color=void 0,this.state.temp.outcome=void 0,this.state.temp.lastMove=void 0},750)},leftPad(e,t,n){for(;e.length<n;)e=t+e;return e}},watch:{"state.temp.outcome":function(e,t){(e==="right"||e==="wrong")&&this.input(e)}},computed:{streakNumber(){return dn(this.state)},puzzleMove(){var n,o;const e=this.puzzle.color==="white"?". ":"... ",t=((o=(n=this.state.temp)==null?void 0:n.lastMove)==null?void 0:o.san)??"";return`${this.puzzle.moveNumber}${e}${t}`}}};const _n=e=>(gt("data-v-2e1fffa3"),e=e(),_t(),e),bn=_n(()=>W("br",null,null,-1)),vn={class:"streak"};function wn(e,t,n,o,i,r){return y(),I(ze,null,{default:b(()=>[n.state?(y(),I(te,{key:0,cols:"5"},{default:b(()=>[E(me,{height:"100%"},{default:b(()=>[E(mt,{"hide-on-leave":""},{default:b(()=>[(y(),I(ce,{key:n.state.correct,class:"large-number foldit text-center py-16 px-4"},{default:b(()=>[j(H(n.state.correct),1)]),_:1}))]),_:1})]),_:1})]),_:1})):ue("",!0),n.puzzle?(y(),I(te,{key:1,cols:"7"},{default:b(()=>[E(Jt,{"hide-on-leave":""},{default:b(()=>[(y(),I(me,{key:n.puzzle.index,color:e.color,loading:!e.color,ref:"puzzleCard"},{loader:b(({isActive:s})=>[E(et,{active:s,color:"#333",height:"4",modelValue:n.puzzle.index,"onUpdate:modelValue":t[0]||(t[0]=a=>n.puzzle.index=a),max:"100000"},null,8,["active","modelValue"])]),default:b(()=>[E(ce,null,{default:b(()=>[j("#"+H(r.leftPad(""+n.puzzle.index,"0",5)),1),bn,j(H(n.puzzle.color==="white"?"WeiÃŸ":"Schwarz")+" am Zug",1)]),_:1}),E(rn,{class:"semilarge py-8"},{default:b(()=>[j(H(r.puzzleMove),1)]),_:1})]),_:1},8,["color","loading"]))]),_:1})]),_:1})):ue("",!0),n.state&&n.state.gameResults[0]?(y(),I(te,{key:2,cols:"4"},{default:b(()=>[E(me,null,{default:b(()=>[E(ce,{class:"mid-number streak"},{default:b(()=>[W("span",null,[E(qe,{size:"60pt",class:"power-icon",color:"yellow-lighten-4"},{default:b(()=>[j("mdi-lightning-bolt")]),_:1})]),W("span",vn,H(r.streakNumber),1)]),_:1})]),_:1})]),_:1})):ue("",!0),E(te,{cols:"4"},{default:b(()=>[E(me,{height:"100%"},{default:b(()=>[E(en,{"hide-on-leave":""},{default:b(()=>[(y(),I(ce,{key:+(e.skipMillisLeft!=0)},{default:b(()=>[e.skipMillisLeft!=0?(y(),I(et,{key:0,class:"rounded-xl",modelValue:e.skipMillisLeft,"onUpdate:modelValue":t[1]||(t[1]=s=>e.skipMillisLeft=s),max:"5000",height:"100%",onClick:t[2]||(t[2]=s=>r.skip(!1))},null,8,["modelValue"])):(y(),I(sn,{key:1,block:"",flat:"",size:"x-large",class:"skip-btn rounded-xl py-12 my-0",onClick:t[3]||(t[3]=s=>r.skip(!0))},{default:b(()=>[j("skip")]),_:1}))]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1})}const kn=Fe(gn,[["render",wn],["__scopeId","data-v-2e1fffa3"]]),Sn={data:()=>({secondsLeft:60,updateSeconds:null,deltas:[]}),props:{timer:{type:Object,required:!0,validator:fn}},emits:["timeUp"],mounted(){this.updateSeconds=setInterval(()=>{if(this.timer.paused)return;this.secondsLeft=(this.timer.end.getTime()-new Date().getTime())/1e3,this.secondsLeft<0&&(this.updateSeconds&&clearInterval(this.updateSeconds),this.$emit("timeUp")),this.timer.deltas.length>0&&this.deltas.push({amount:this.timer.deltas.pop(),shown:20}),this.deltas=this.deltas.filter(t=>t.shown>=0);for(const t of this.deltas)t.shown--;const e=this.$refs.colon;e&&e instanceof HTMLElement&&(this.secondsLeft%1>.5?e.style.color="#ccc":e.style.color="#999")},100)},computed:{minutes(){return Math.floor(this.secondsLeft/60).toString()},seconds(){let e=Math.floor(this.secondsLeft%60).toString();for(;e.length<2;)e="0"+e;return e},tenths(){return Math.floor(this.secondsLeft%1*10).toString()}},methods:{color(e){const t=e.amount>0?[0,200,0]:e.amount<0?[200,0,0]:[50,50,50];return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${Math.sin(e.shown/20*Math.PI)}`}}};const vt=e=>(gt("data-v-5f0deb7d"),e=e(),_t(),e),yn={class:"mx-n12",ref:"colon"},Cn={key:0,class:"tenths rounded-lg px-5 my-0"},En={class:"pl-0 text-h5"},Pn=vt(()=>W("span",{class:"pl-0 text-h5"},"s",-1)),Mn=vt(()=>W("br",null,null,-1));function Tn(e,t,n,o,i,r){return y(),I(me,null,{default:b(()=>[e.secondsLeft>=0?(y(),I(ce,{key:0,class:"timer"},{default:b(()=>[E(ze,null,{default:b(()=>[E(te,{cols:"8"},{default:b(()=>[E(mt,{"hide-on-leave":""},{default:b(()=>[(y(),ve("span",{key:r.minutes},H(r.minutes),1))]),_:1}),W("span",yn," : ",512),(y(),ve("span",{key:e.secondsLeft},H(r.seconds),1)),e.secondsLeft<=10?(y(),ve("span",Cn,H(r.tenths),1)):ue("",!0)]),_:1}),E(te,{cols:"4"},{default:b(()=>[W("span",null,[(y(!0),ve(nn,null,tn(e.deltas,(s,a)=>(y(),I(me,{class:"delta",key:s.amount+a,color:r.color(s),"max-width":"95px"},{default:b(()=>[E(ce,{class:"pl-0"},{default:b(()=>[s.amount>0?(y(),I(qe,{key:0},{default:b(()=>[j("mdi-plus")]),_:1})):s.amount<0?(y(),I(qe,{key:1},{default:b(()=>[j("mdi-minus")]),_:1})):ue("",!0),W("span",En,H(Math.abs(s.amount)),1),Pn]),_:2},1024)]),_:2},1032,["color"]))),128))])]),_:1})]),_:1})]),_:1})):(y(),I(ce,{key:1,class:"time-up"},{default:b(()=>[j(" Zeit "),Mn,j(" abgelaufen! ")]),_:1}))]),_:1})}const An=Fe(Sn,[["render",Tn],["__scopeId","data-v-5f0deb7d"]]),In=["white","black"],Be=["a","b","c","d","e","f","g","h"],Ue=["1","2","3","4","5","6","7","8"],Nn=[...Ue].reverse(),Ve=Array.prototype.concat(...Be.map(e=>Ue.map(t=>e+t))),K=e=>Ve[8*e[0]+e[1]],C=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],wt=Ve.map(C);function xn(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const Rn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},je=e=>e==="white"?"black":"white",ke=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},De=(e,t)=>e.role===t.role&&e.color===t.color,ye=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],V=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},kt=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},He=(e,t)=>{e.style.visibility=t?"visible":"hidden"},he=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},St=e=>e.buttons===2||e.button===2,Q=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function yt(e,t,n){const o=C(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}const fe=(e,t)=>Math.abs(e-t),Ln=e=>(t,n,o,i)=>fe(t,o)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===o:i===n-1||n>=6&&i===n-2&&t===o),Ct=(e,t,n,o)=>{const i=fe(e,n),r=fe(t,o);return i===1&&r===2||i===2&&r===1},Et=(e,t,n,o)=>fe(e,n)===fe(t,o),Pt=(e,t,n,o)=>e===n||t===o,Mt=(e,t,n,o)=>Et(e,t,n,o)||Pt(e,t,n,o),qn=(e,t,n)=>(o,i,r,s)=>fe(o,r)<2&&fe(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(o===4&&(r===2&&t.includes(0)||r===6&&t.includes(7))||t.includes(r));function Dn(e,t){const n=t==="white"?"1":"8",o=[];for(const[i,r]of e)i[1]===n&&r.color===t&&r.role==="rook"&&o.push(C(i)[0]);return o}function Tt(e,t,n){const o=e.get(t);if(!o)return[];const i=C(t),r=o.role,s=r==="pawn"?Ln(o.color):r==="knight"?Ct:r==="bishop"?Et:r==="rook"?Pt:r==="queen"?Mt:qn(o.color,Dn(e,o.color),n);return wt.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&s(i[0],i[1],a[0],a[1])).map(K)}function R(e,...t){e&&setTimeout(()=>e(...t),1)}function On(e){e.orientation=je(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Kn(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}function $n(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,o]of e.pieces)o.role==="king"&&o.color===t&&(e.check=n)}function Fn(e,t,n,o){ie(e),e.premovable.current=[t,n],R(e.premovable.events.set,t,n,o)}function oe(e){e.premovable.current&&(e.premovable.current=void 0,R(e.premovable.events.unset))}function zn(e,t,n){oe(e),e.predroppable.current={role:t,key:n},R(e.predroppable.events.set,t,n)}function ie(e){const t=e.predroppable;t.current&&(t.current=void 0,R(t.events.unset))}function Bn(e,t,n){if(!e.autoCastle)return!1;const o=e.pieces.get(t);if(!o||o.role!=="king")return!1;const i=C(t),r=C(n);if(i[1]!==0&&i[1]!==7||i[1]!==r[1])return!1;i[0]===4&&!e.pieces.has(n)&&(r[0]===6?n=K([7,r[1]]):r[0]===2&&(n=K([0,r[1]])));const s=e.pieces.get(n);return!s||s.color!==o.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<r[0]?(e.pieces.set(K([6,r[1]]),o),e.pieces.set(K([5,r[1]]),s)):(e.pieces.set(K([2,r[1]]),o),e.pieces.set(K([3,r[1]]),s)),!0)}function At(e,t,n){const o=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!o)return!1;const r=i&&i.color!==o.color?i:void 0;return n===e.selected&&F(e),R(e.events.move,t,n,r),Bn(e,t,n)||(e.pieces.set(n,o),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,R(e.events.change),r||!0}function Qe(e,t,n,o){if(e.pieces.has(n))if(o)e.pieces.delete(n);else return!1;return R(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,R(e.events.change),e.movable.dests=void 0,e.turnColor=je(e.turnColor),!0}function It(e,t,n){const o=At(e,t,n);return o&&(e.movable.dests=void 0,e.turnColor=je(e.turnColor),e.animation.current=void 0),o}function Nt(e,t,n){if(We(e,t,n)){const o=It(e,t,n);if(o){const i=e.hold.stop();F(e);const r={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return o!==!0&&(r.captured=o),R(e.movable.events.after,t,n,r),!0}}else if(Vn(e,t,n))return Fn(e,t,n,{ctrlKey:e.stats.ctrlKey}),F(e),!0;return F(e),!1}function xt(e,t,n,o){const i=e.pieces.get(t);i&&(Un(e,t,n)||o)?(e.pieces.delete(t),Qe(e,i,n,o),R(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&jn(e,t,n)?zn(e,i.role,n):(oe(e),ie(e)),e.pieces.delete(t),F(e)}function Oe(e,t,n){if(R(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){F(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&Nt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Lt(e,t)||Ge(e,t))&&(Rt(e,t),e.hold.start())}function Rt(e,t){e.selected=t,Ge(e,t)?e.premovable.dests=Tt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function F(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Lt(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const We=(e,t,n)=>{var o,i;return t!==n&&Lt(e,t)&&(e.movable.free||!!(!((i=(o=e.movable.dests)===null||o===void 0?void 0:o.get(t))===null||i===void 0)&&i.includes(n)))};function Un(e,t,n){const o=e.pieces.get(t);return!!o&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}function Ge(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}const Vn=(e,t,n)=>t!==n&&Ge(e,t)&&Tt(e.pieces,t,e.premovable.castle).includes(n);function jn(e,t,n){const o=e.pieces.get(t),i=e.pieces.get(n);return!!o&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(o.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===o.color&&e.turnColor!==o.color}function Hn(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function Qn(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let i=!1;if(We(e,n,o)){const r=It(e,n,o);if(r){const s={premove:!0};r!==!0&&(s.captured=r),R(e.movable.events.after,n,o,s),i=!0}}return oe(e),i}function Wn(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;if(t(n)){const i={role:n.role,color:e.movable.color};Qe(e,i,n.key)&&(R(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0)}return ie(e),o}function Ze(e){oe(e),ie(e),F(e)}function tt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Ze(e)}function pe(e,t,n){let o=Math.floor(8*(e[0]-n.left)/n.width);t||(o=7-o);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),o>=0&&o<8&&i>=0&&i<8?K([o,i]):void 0}function Gn(e,t,n,o){const i=C(e),r=wt.filter(l=>Mt(i[0],i[1],l[0],l[1])||Ct(i[0],i[1],l[0],l[1])),a=r.map(l=>yt(K(l),n,o)).map(l=>ke(t,l)),[,c]=a.reduce((l,h,f)=>l[0]<h?l:[h,f],[a[0],0]);return K(r[c])}const L=e=>e.orientation==="white",qt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Zn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Yn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Dt(e){e==="start"&&(e=qt);const t=new Map;let n=7,o=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;o=0;break;case"~":{const r=t.get(K([o-1,n]));r&&(r.promoted=!0);break}default:{const r=i.charCodeAt(0);if(r<57)o+=r-48;else{const s=i.toLowerCase();t.set(K([o,n]),{role:Zn[s],color:i===s?"black":"white"}),++o}}}return t}function Xn(e){return Nn.map(t=>Be.map(n=>{const o=e.get(n+t);if(o){let i=Yn[o.role];return o.color==="white"&&(i=i.toUpperCase()),o.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Ot(e,t){t.animation&&(Ye(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Kt(e,t){var n,o,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((o=t.drawable)===null||o===void 0)&&o.autoShapes&&(e.drawable.autoShapes=[]),Ye(e,t),t.fen&&(e.pieces=Dt(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&$n(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Rt(e,e.selected),Ot(e,t),!e.movable.rookCastle&&e.movable.dests){const r=e.movable.color==="white"?"1":"8",s="e"+r,a=e.movable.dests.get(s),c=e.pieces.get(s);if(!a||!c||c.role!=="king")return;e.movable.dests.set(s,a.filter(l=>!(l==="a"+r&&a.includes("c"+r))&&!(l==="h"+r&&a.includes("g"+r))))}}function Ye(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&nt(e[n])&&nt(t[n])?Ye(e[n],t[n]):e[n]=t[n])}function nt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const le=(e,t)=>t.animation.enabled?to(e,t):J(e,t);function J(e,t){const n=e(t);return t.dom.redraw(),n}const Ae=(e,t)=>({key:e,pos:C(e),piece:t}),Jn=(e,t)=>t.sort((n,o)=>ke(e.pos,n.pos)-ke(e.pos,o.pos))[0];function eo(e,t){const n=new Map,o=[],i=new Map,r=[],s=[],a=new Map;let c,l,h;for(const[f,u]of e)a.set(f,Ae(f,u));for(const f of Ve)c=t.pieces.get(f),l=a.get(f),c?l?De(c,l.piece)||(r.push(l),s.push(Ae(f,c))):s.push(Ae(f,c)):l&&r.push(l);for(const f of s)l=Jn(f,r.filter(u=>De(f.piece,u.piece))),l&&(h=[l.pos[0]-f.pos[0],l.pos[1]-f.pos[1]],n.set(f.key,h.concat(h)),o.push(l.key));for(const f of r)o.includes(f.key)||i.set(f.key,f.piece);return{anims:n,fadings:i}}function $t(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const o=1-(t-n.start)*n.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=no(o);for(const r of n.plan.anims.values())r[2]=r[0]*i,r[3]=r[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((r=performance.now())=>$t(e,r))}}function to(e,t){const n=new Map(t.pieces),o=e(t),i=eo(n,t);if(i.anims.size||i.fadings.size){const r=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},r||$t(t,performance.now())}else t.dom.redraw();return o}const no=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,oo=["green","red","blue","yellow"];function io(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?F(e):Ze(e);const n=he(t),o=pe(n,L(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:lo(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Ft(e))}function Ft(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=pe(t.pos,L(e),e.dom.bounds());n||(t.snapToValidMove=!1);const o=t.snapToValidMove?Gn(t.orig,t.pos,L(e),e.dom.bounds()):n;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),Ft(e)}})}function ro(e,t){e.drawable.current&&(e.drawable.current.pos=he(t))}function so(e){const t=e.drawable.current;t&&(t.mouseSq&&co(e.drawable,t),zt(e))}function zt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ao(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Bt(e.drawable))}function lo(e){var t;const n=(e.shiftKey||e.ctrlKey)&&St(e),o=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return oo[(n?1:0)+(o?2:0)]}function co(e,t){const n=i=>i.orig===t.orig&&i.dest===t.dest,o=e.shapes.find(n);o&&(e.shapes=e.shapes.filter(i=>!n(i))),(!o||o.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Bt(e)}function Bt(e){e.onChange&&e.onChange(e.shapes)}function uo(e,t){if(!t.isTrusted||t.button!==void 0&&t.button!==0||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=he(t),i=pe(o,L(e),n);if(!i)return;const r=e.pieces.get(i),s=e.selected;!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!r||r.color!==e.turnColor)&&ao(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||r||s||fo(e,o))&&t.preventDefault();const a=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&We(e,e.selected,i)?le(f=>Oe(f,i),e):Oe(e,i);const l=e.selected===i,h=Vt(e,i);if(r&&h&&l&&Hn(e,i)){e.draggable.current={orig:i,piece:r,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},h.cgDragging=!0,h.classList.add("dragging");const f=e.dom.elements.ghost;f&&(f.className=`ghost ${r.color} ${r.role}`,V(f,ye(n)(C(i),L(e))),He(f,!0)),Xe(e)}else a&&oe(e),c&&ie(e);e.dom.redraw()}function fo(e,t){const n=L(e),o=e.dom.bounds(),i=Math.pow(o.width/8,2);for(const r of e.pieces.keys()){const s=yt(r,n,o);if(ke(s,t)<=i)return!0}return!1}function ho(e,t,n,o){const i="a0";e.pieces.set(i,t),e.dom.redraw();const r=he(n);e.draggable.current={orig:i,piece:t,origPos:r,pos:r,started:!0,element:()=>Vt(e,i),originTarget:n.target,newPiece:!0,force:!!o,keyHasChanged:!1},Xe(e)}function Xe(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const o=e.pieces.get(n.orig);if(!o||!De(o,n.piece))Me(e);else if(!n.started&&ke(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const r=n.element();if(!r)return;r.cgDragging=!0,r.classList.add("dragging"),n.element=r}const i=e.dom.bounds();V(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==pe(n.pos,L(e),i))}Xe(e)})}function po(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=he(t))}function mo(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}oe(e),ie(e);const o=he(t)||n.pos,i=pe(o,L(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?xt(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,Nt(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),R(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?F(e):e.selectable.enabled||F(e),Ut(e),e.draggable.current=void 0,e.dom.redraw()}function Me(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,F(e),Ut(e),e.dom.redraw())}function Ut(e){const t=e.dom.elements;t.ghost&&He(t.ghost,!1)}function Vt(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function go(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{ot(e,2),setTimeout(()=>ot(e,void 0),120)},120)}function ot(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function _o(e,t){function n(){On(e),t()}return{set(o){o.orientation&&o.orientation!==e.orientation&&n(),Ot(e,o),(o.fen?le:J)(i=>Kt(i,o),e)},state:e,getFen:()=>Xn(e.pieces),toggleOrientation:n,setPieces(o){le(i=>Kn(i,o),e)},selectSquare(o,i){o?le(r=>Oe(r,o,i),e):e.selected&&(F(e),e.dom.redraw())},move(o,i){le(r=>At(r,o,i),e)},newPiece(o,i){le(r=>Qe(r,o,i),e)},playPremove(){if(e.premovable.current){if(le(Qn,e))return!0;e.dom.redraw()}return!1},playPredrop(o){if(e.predroppable.current){const i=Wn(e,o);return e.dom.redraw(),i}return!1},cancelPremove(){J(oe,e)},cancelPredrop(){J(ie,e)},cancelMove(){J(o=>{Ze(o),Me(o)},e)},stop(){J(o=>{tt(o),Me(o)},e)},explode(o){go(e,o)},setAutoShapes(o){J(i=>i.drawable.autoShapes=o,e)},setShapes(o){J(i=>i.drawable.shapes=o,e)},getKeyAtDomPos(o){return pe(o,L(e),e.dom.bounds())},redrawAll:t,dragNewPiece(o,i,r){ho(e,o,i,r)},destroy(){tt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function bo(){return{pieces:Dt(qt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Rn()}}function Ke(e,t,n){const o=new Map,i=[];for(const a of e)o.set(a.hash,!1);let r=t.firstChild,s;for(;r;)s=r.getAttribute("cgHash"),o.has(s)?o.set(s,!0):i.push(r),r=r.nextSibling;for(const a of i)t.removeChild(a);for(const a of e)o.get(a.hash)||t.appendChild(n(a))}function $(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function vo(e,t,n){const o=e.drawable,i=o.current,r=i&&i.mouseSq?i:void 0,s=new Map,a=e.dom.bounds(),c=o.autoShapes.filter(d=>!d.piece);for(const d of o.shapes.concat(c).concat(r?[r]:[]))d.dest&&s.set(d.dest,(s.get(d.dest)||0)+1);const l=o.shapes.concat(c).map(d=>({shape:d,current:!1,hash:it(d,s,!1,a)}));r&&l.push({shape:r,current:!0,hash:it(r,s,!0,a)});const h=l.map(d=>d.hash).join(";");if(h===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=h;const f=t.querySelector("defs"),u=t.querySelector("g"),v=n.querySelector("g");wo(o,l,f),Ke(l.filter(d=>!d.shape.customSvg),u,d=>rt(e,d,o.brushes,s,a)),Ke(l.filter(d=>d.shape.customSvg),v,d=>rt(e,d,o.brushes,s,a))}function wo(e,t,n){var o;const i=new Map;let r;for(const c of t)c.shape.dest&&(r=e.brushes[c.shape.brush],c.shape.modifiers&&(r=jt(r,c.shape.modifiers)),!((o=c.shape.modifiers)===null||o===void 0)&&o.hilite&&i.set("hilite",{key:"hilite",color:"white",opacity:1,lineWidth:1}),i.set(r.key,r));const s=new Set;let a=n.firstChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextSibling;for(const[c,l]of i.entries())s.has(c)||n.appendChild(Mo(l))}function it({orig:e,dest:t,brush:n,piece:o,modifiers:i,customSvg:r},s,a,c){return[c.width,c.height,a,e,t,n,t&&(s.get(t)||0)>1,o&&ko(o),i&&So(i),r&&yo(r)].filter(l=>l).join(",")}function ko(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function So(e){return[e.lineWidth,e.hilite].filter(t=>t).join(",")}function yo(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function rt(e,{shape:t,current:n,hash:o},i,r,s){var a;let c;const l=st(C(t.orig),e.orientation);if(t.customSvg)c=Co(t.customSvg,l,s);else if(t.dest){let h=i[t.brush];t.modifiers&&(h=jt(h,t.modifiers)),c=Po(h,l,st(C(t.dest),e.orientation),n,(r.get(t.dest)||0)>1,s,(a=t.modifiers)===null||a===void 0?void 0:a.hilite)}else c=Eo(i[t.brush],l,n,s);return c.setAttribute("cgHash",o),c}function Co(e,t,n){const[o,i]=Te(t,n),r=ne($("g"),{transform:`translate(${o},${i})`}),s=ne($("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return r.appendChild(s),s.innerHTML=e,r}function Eo(e,t,n,o){const i=Te(t,o),r=To(),s=(o.width+o.height)/(4*Math.max(o.width,o.height));return ne($("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:Ht(e,n),cx:i[0],cy:i[1],r:s-r[1]/2})}function Po(e,t,n,o,i,r,s=!1){function a(l){const h=Io(i&&!o),f=Te(t,r),u=Te(n,r),v=u[0]-f[0],d=u[1]-f[1],p=Math.atan2(d,v),w=Math.cos(p)*h,S=Math.sin(p)*h;return ne($("line"),{stroke:l?"white":e.color,"stroke-width":Ao(e,o)+(l?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${l?"hilite":e.key})`,opacity:l?1:Ht(e,o),x1:f[0],y1:f[1],x2:u[0]-w,y2:u[1]-S})}const c=s?$("g"):a(!1);return s&&[!0,!1].map(l=>c.appendChild(a(l))),c}function Mo(e){const t=ne($("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:e.key==="hilite"?1.86:2.05,refY:2});return t.appendChild(ne($("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function ne(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function st(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function jt(e,t){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}}function To(){return[3/64,4/64]}function Ao(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Ht(e,t){return(e.opacity||1)*(t?.9:1)}function Io(e){return(e?20:10)/64}function Te(e,t){const n=Math.min(1,t.width/t.height),o=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*o]}function No(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of In)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=Q("cg-container");e.appendChild(n);const o=Q("cg-board");n.appendChild(o);let i,r,s;if(t.drawable.visible&&(i=ne($("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild($("defs")),i.appendChild($("g")),r=ne($("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild($("g")),s=Q("cg-auto-pieces"),n.appendChild(i),n.appendChild(r),n.appendChild(s)),t.coordinates){const c=t.orientation==="black"?" black":"",l=t.ranksPosition==="left"?" left":"";n.appendChild(at(Ue,"ranks"+c+l)),n.appendChild(at(Be,"files"+c))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=Q("piece","ghost"),He(a,!1),n.appendChild(a)),{board:o,container:n,wrap:e,ghost:a,svg:i,customSvg:r,autoPieces:s}}function at(e,t){const n=Q("coords",t);let o;for(const i of e)o=Q("coord"),o.textContent=i,n.appendChild(o);return n}function xo(e,t){if(!e.dropmode.active)return;oe(e),ie(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const o=he(t),i=o&&pe(o,L(e),e.dom.bounds());i&&xt(e,"a0",i)}e.dom.redraw()}function Ro(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const o=qo(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1})}function Lo(e,t){const n=[];if("ResizeObserver"in window||n.push(ge(document.body,"chessground.resize",t)),!e.viewOnly){const o=lt(e,po,ro),i=lt(e,mo,so);for(const s of["touchmove","mousemove"])n.push(ge(document,s,o));for(const s of["touchend","mouseup"])n.push(ge(document,s,i));const r=()=>e.dom.bounds.clear();n.push(ge(document,"scroll",r,{capture:!0,passive:!0})),n.push(ge(window,"resize",r,{passive:!0}))}return()=>n.forEach(o=>o())}function ge(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}const qo=e=>t=>{e.draggable.current?Me(e):e.drawable.current?zt(e):t.shiftKey||St(t)?e.drawable.enabled&&io(e,t):e.viewOnly||(e.dropmode.active?xo(e,t):uo(e,t))},lt=(e,t,n)=>o=>{e.drawable.current?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)};function Do(e){const t=L(e),n=ye(e.dom.bounds()),o=e.dom.elements.board,i=e.pieces,r=e.animation.current,s=r?r.plan.anims:new Map,a=r?r.plan.fadings:new Map,c=e.draggable.current,l=Ko(e),h=new Set,f=new Set,u=new Map,v=new Map;let d,p,w,S,M,g,N,P,re,se;for(p=o.firstChild;p;){if(d=p.cgKey,Qt(p))if(w=i.get(d),M=s.get(d),g=a.get(d),S=p.cgPiece,p.cgDragging&&(!c||c.orig!==d)&&(p.classList.remove("dragging"),V(p,n(C(d),t)),p.cgDragging=!1),!g&&p.cgFading&&(p.cgFading=!1,p.classList.remove("fading")),w){if(M&&p.cgAnimating&&S===_e(w)){const k=C(d);k[0]+=M[2],k[1]+=M[3],p.classList.add("anim"),V(p,n(k,t))}else p.cgAnimating&&(p.cgAnimating=!1,p.classList.remove("anim"),V(p,n(C(d),t)),e.addPieceZIndex&&(p.style.zIndex=Ie(C(d),t)));S===_e(w)&&(!g||!p.cgFading)?h.add(d):g&&S===_e(g)?(p.classList.add("fading"),p.cgFading=!0):Ne(u,S,p)}else Ne(u,S,p);else if(Wt(p)){const k=p.className;l.get(d)===k?f.add(d):Ne(v,k,p)}p=p.nextSibling}for(const[k,G]of l)if(!f.has(k)){re=v.get(G),se=re&&re.pop();const B=n(C(k),t);if(se)se.cgKey=k,V(se,B);else{const U=Q("square",G);U.cgKey=k,V(U,B),o.insertBefore(U,o.firstChild)}}for(const[k,G]of i)if(M=s.get(k),!h.has(k))if(N=u.get(_e(G)),P=N&&N.pop(),P){P.cgKey=k,P.cgFading&&(P.classList.remove("fading"),P.cgFading=!1);const B=C(k);e.addPieceZIndex&&(P.style.zIndex=Ie(B,t)),M&&(P.cgAnimating=!0,P.classList.add("anim"),B[0]+=M[2],B[1]+=M[3]),V(P,n(B,t))}else{const B=_e(G),U=Q("piece",B),Ce=C(k);U.cgPiece=B,U.cgKey=k,M&&(U.cgAnimating=!0,Ce[0]+=M[2],Ce[1]+=M[3]),V(U,n(Ce,t)),e.addPieceZIndex&&(U.style.zIndex=Ie(Ce,t)),o.appendChild(U)}for(const k of u.values())ut(e,k);for(const k of v.values())ut(e,k)}function Oo(e){const t=L(e),n=ye(e.dom.bounds());let o=e.dom.elements.board.firstChild;for(;o;)(Qt(o)&&!o.cgAnimating||Wt(o))&&V(o,n(C(o.cgKey),t)),o=o.nextSibling}function ct(e){var t,n;const o=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,r=o.height/o.width,s=Math.floor(o.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*r;i.style.width=s+"px",i.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("--cg-height",a+"px")}const Qt=e=>e.tagName==="PIECE",Wt=e=>e.tagName==="SQUARE";function ut(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Ie(e,t){const o=e[1];return`${t?3+7-o:3+o}`}const _e=e=>`${e.color} ${e.role}`;function Ko(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const r of e.lastMove)Z(n,r,"last-move");if(e.check&&e.highlight.check&&Z(n,e.check,"check"),e.selected&&(Z(n,e.selected,"selected"),e.movable.showDests)){const r=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(r)for(const a of r)Z(n,a,"move-dest"+(e.pieces.has(a)?" oc":""));const s=e.premovable.dests;if(s)for(const a of s)Z(n,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const r of o)Z(n,r,"current-premove");else e.predroppable.current&&Z(n,e.predroppable.current.key,"current-premove");const i=e.exploding;if(i)for(const r of i.keys)Z(n,r,"exploding"+i.stage);return n}function Z(e,t,n){const o=e.get(t);o?e.set(t,`${o} ${n}`):e.set(t,n)}function Ne(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function $o(e,t){const o=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Bo(i),current:!1}));Ke(o,t,i=>zo(e,i,e.dom.bounds()))}function Fo(e){var t;const n=L(e),o=ye(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)kt(i,o(C(i.cgKey),n),i.cgScale),i=i.nextSibling}function zo(e,{shape:t,hash:n},o){var i,r,s;const a=t.orig,c=(i=t.piece)===null||i===void 0?void 0:i.role,l=(r=t.piece)===null||r===void 0?void 0:r.color,h=(s=t.piece)===null||s===void 0?void 0:s.scale,f=Q("piece",`${c} ${l}`);return f.setAttribute("cgHash",n),f.cgKey=a,f.cgScale=h,kt(f,ye(o)(C(a),L(e)),h),f}const Bo=e=>{var t,n,o;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(o=e.piece)===null||o===void 0?void 0:o.scale].join(",")};function Uo(e,t){const n=bo();Kt(n,t||{});function o(){const i="dom"in n?n.dom.unbind:void 0,r=No(e,n),s=xn(()=>r.board.getBoundingClientRect()),a=h=>{Do(l),r.autoPieces&&$o(l,r.autoPieces),!h&&r.svg&&vo(l,r.svg,r.customSvg)},c=()=>{ct(l),Oo(l),r.autoPieces&&Fo(l)},l=n;return l.dom={elements:r,bounds:s,redraw:Vo(a),redrawNow:a,unbind:i},l.drawable.prevSvgHash="",ct(l),a(!1),Ro(l,c),i||(l.dom.unbind=Lo(l,c)),l.events.insert&&l.events.insert(r),l}return _o(o(),o)}function Vo(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const x="w",O="b",T="p",$e="n",Pe="b",we="r",ee="q",A="k",xe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",q=-1,jo={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},m={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},_={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},Re={b:[16,32,17,15],w:[-16,-32,-17,-15]},dt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ho=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Qo=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Wo={p:1,n:2,b:4,r:8,q:16,k:32},Go="pnbrqkPNBRQK",ft=[$e,Pe,we,ee],Zo=7,Yo=6,Xo=1,Jo=0,Ee={[A]:m.KSIDE_CASTLE,[ee]:m.QSIDE_CASTLE},Y={w:[{square:_.a1,flag:m.QSIDE_CASTLE},{square:_.h1,flag:m.KSIDE_CASTLE}],b:[{square:_.a8,flag:m.QSIDE_CASTLE},{square:_.h8,flag:m.KSIDE_CASTLE}]},ei={b:Xo,w:Yo},ti=["1-0","0-1","1/2-1/2","*"];function de(e){return e>>4}function Se(e){return e&15}function Gt(e){return"0123456789".indexOf(e)!==-1}function D(e){const t=Se(e),n=de(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function be(e){return e===x?O:x}function ni(e){const t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(t[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const o=parseInt(t[4],10);if(isNaN(o)||o<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<i.length;s++){let a=0,c=!1;for(let l=0;l<i[s].length;l++)if(Gt(i[s][l])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(i[s][l],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[s][l]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,c=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:s,regex:a}of r){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return{ok:!0}}function oi(e,t){const n=e.from,o=e.to,i=e.piece;let r=0,s=0,a=0;for(let c=0,l=t.length;c<l;c++){const h=t[c].from,f=t[c].to,u=t[c].piece;i===u&&n!==h&&o===f&&(r++,de(n)===de(h)&&s++,Se(n)===Se(h)&&a++)}return r>0?s>0&&a>0?D(n):a>0?D(n).charAt(1):D(n).charAt(0):""}function X(e,t,n,o,i,r=void 0,s=m.NORMAL){const a=de(o);if(i===T&&(a===Zo||a===Jo))for(let c=0;c<ft.length;c++){const l=ft[c];e.push({color:t,from:n,to:o,piece:i,captured:r,promotion:l,flags:s|m.PROMOTION})}else e.push({color:t,from:n,to:o,piece:i,captured:r,flags:s})}function ht(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?A:t)}function Le(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class pt{constructor(t=xe){z(this,"_board",new Array(128));z(this,"_turn",x);z(this,"_header",{});z(this,"_kings",{w:q,b:q});z(this,"_epSquare",-1);z(this,"_halfMoves",0);z(this,"_moveNumber",0);z(this,"_history",[]);z(this,"_comments",{});z(this,"_castling",{w:0,b:0});this.load(t)}clear(t=!1){this._board=new Array(128),this._kings={w:q,b:q},this._turn=x,this._castling={w:0,b:0},this._epSquare=q,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{},this._updateSetup(this.fen())}removeHeader(t){t in this._header&&delete this._header[t]}load(t,n=!1){let o=t.split(/\s+/);if(o.length>=2&&o.length<6){const c=["-","-","0","1"];t=o.concat(c.slice(-(6-o.length))).join(" ")}o=t.split(/\s+/);const{ok:i,error:r}=ni(t);if(!i)throw new Error(r);const s=o[0];let a=0;this.clear(n);for(let c=0;c<s.length;c++){const l=s.charAt(c);if(l==="/")a+=8;else if(Gt(l))a+=parseInt(l,10);else{const h=l<"a"?x:O;this.put({type:l.toLowerCase(),color:h},D(a)),a++}}this._turn=o[1],o[2].indexOf("K")>-1&&(this._castling.w|=m.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(this._castling.w|=m.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(this._castling.b|=m.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(this._castling.b|=m.QSIDE_CASTLE),this._epSquare=o[3]==="-"?q:_[o[3]],this._halfMoves=parseInt(o[4],10),this._moveNumber=parseInt(o[5],10),this._updateSetup(this.fen())}fen(){var r,s;let t=0,n="";for(let a=_.a8;a<=_.h1;a++){if(this._board[a]){t>0&&(n+=t,t=0);const{color:c,type:l}=this._board[a];n+=c===x?l.toUpperCase():l.toLowerCase()}else t++;a+1&136&&(t>0&&(n+=t),a!==_.h1&&(n+="/"),t=0,a+=8)}let o="";this._castling[x]&m.KSIDE_CASTLE&&(o+="K"),this._castling[x]&m.QSIDE_CASTLE&&(o+="Q"),this._castling[O]&m.KSIDE_CASTLE&&(o+="k"),this._castling[O]&m.QSIDE_CASTLE&&(o+="q"),o=o||"-";let i="-";if(this._epSquare!==q){const a=this._epSquare+(this._turn===x?16:-16),c=[a+1,a-1];for(const l of c){if(l&136)continue;const h=this._turn;if(((r=this._board[l])==null?void 0:r.color)===h&&((s=this._board[l])==null?void 0:s.type)===T){this._makeMove({color:h,from:l,to:this._epSquare,piece:T,captured:T,flags:m.EP_CAPTURE});const f=!this._isKingAttacked(h);if(this._undoMove(),f){i=D(this._epSquare);break}}}}return[n,this._turn,o,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(t){this._history.length>0||(t!==xe?(this._header.SetUp="1",this._header.FEN=t):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(xe)}get(t){return this._board[_[t]]||!1}put({type:t,color:n},o){if(Go.indexOf(t.toLowerCase())===-1||!(o in _))return!1;const i=_[o];return t==A&&!(this._kings[n]==q||this._kings[n]==i)?!1:(this._board[i]={type:t,color:n},t===A&&(this._kings[n]=i),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}remove(t){const n=this.get(t);return delete this._board[_[t]],n&&n.type===A&&(this._kings[n.color]=q),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),n}_updateCastlingRights(){var o,i,r,s,a,c,l,h,f,u,v,d;const t=((o=this._board[_.e1])==null?void 0:o.type)===A&&((i=this._board[_.e1])==null?void 0:i.color)===x,n=((r=this._board[_.e8])==null?void 0:r.type)===A&&((s=this._board[_.e8])==null?void 0:s.color)===O;(!t||((a=this._board[_.a1])==null?void 0:a.type)!==we||((c=this._board[_.a1])==null?void 0:c.color)!==x)&&(this._castling.w&=~m.QSIDE_CASTLE),(!t||((l=this._board[_.h1])==null?void 0:l.type)!==we||((h=this._board[_.h1])==null?void 0:h.color)!==x)&&(this._castling.w&=~m.KSIDE_CASTLE),(!n||((f=this._board[_.a8])==null?void 0:f.type)!==we||((u=this._board[_.a8])==null?void 0:u.color)!==O)&&(this._castling.b&=~m.QSIDE_CASTLE),(!n||((v=this._board[_.h8])==null?void 0:v.type)!==we||((d=this._board[_.h8])==null?void 0:d.color)!==O)&&(this._castling.b&=~m.KSIDE_CASTLE)}_updateEnPassantSquare(){var r,s;if(this._epSquare===q)return;const t=this._epSquare+(this._turn===x?-16:16),n=this._epSquare+(this._turn===x?16:-16),o=[n+1,n-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((r=this._board[n])==null?void 0:r.color)!==be(this._turn)||((s=this._board[n])==null?void 0:s.type)!==T){this._epSquare=q;return}const i=a=>{var c,l;return!(a&136)&&((c=this._board[a])==null?void 0:c.color)===this._turn&&((l=this._board[a])==null?void 0:l.type)===T};o.some(i)||(this._epSquare=q)}_attacked(t,n){for(let o=_.a8;o<=_.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const i=this._board[o],r=o-n;if(r===0)continue;const s=r+119;if(Ho[s]&Wo[i.type]){if(i.type===T){if(r>0){if(i.color===x)return!0}else if(i.color===O)return!0;continue}if(i.type==="n"||i.type==="k")return!0;const a=Qo[s];let c=o+a,l=!1;for(;c!==n;){if(this._board[c]!=null){l=!0;break}c+=a}if(!l)return!0}}return!1}_isKingAttacked(t){const n=this._kings[t];return n===-1?!1:this._attacked(be(t),n)}isAttacked(t,n){return this._attacked(n,_[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},n=[];let o=0,i=0;for(let r=_.a8;r<=_.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const s=this._board[r];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===Pe&&n.push(i),o++)}if(o===2)return!0;if(o===3&&(t[Pe]===1||t[$e]===1))return!0;if(o===t[Pe]+2){let r=0;const s=n.length;for(let a=0;a<s;a++)r+=n[a];if(r===0||r===s)return!0}return!1}isThreefoldRepetition(){const t=[],n={};let o=!1;for(;;){const i=this._undoMove();if(!i)break;t.push(i)}for(;;){const i=this.fen().split(" ").slice(0,4).join(" ");n[i]=i in n?n[i]+1:1,n[i]>=3&&(o=!0);const r=t.pop();if(r)this._makeMove(r);else break}return o}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:t=!1,square:n=void 0,piece:o=void 0}={}){const i=this._moves({square:n,piece:o});return t?i.map(r=>this._makePretty(r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:t=!0,piece:n=void 0,square:o=void 0}={}){var v;const i=o?o.toLowerCase():void 0,r=n==null?void 0:n.toLowerCase(),s=[],a=this._turn,c=be(a);let l=_.a8,h=_.h1,f=!1;if(i)if(i in _)l=h=_[i],f=!0;else return[];for(let d=l;d<=h;d++){if(d&136){d+=7;continue}if(!this._board[d]||this._board[d].color===c)continue;const{type:p}=this._board[d];let w;if(p===T){if(r&&r!==p)continue;w=d+Re[a][0],this._board[w]||(X(s,a,d,w,T),w=d+Re[a][1],ei[a]===de(d)&&!this._board[w]&&X(s,a,d,w,T,void 0,m.BIG_PAWN));for(let S=2;S<4;S++)w=d+Re[a][S],!(w&136)&&(((v=this._board[w])==null?void 0:v.color)===c?X(s,a,d,w,T,this._board[w].type,m.CAPTURE):w===this._epSquare&&X(s,a,d,w,T,T,m.EP_CAPTURE))}else{if(r&&r!==p)continue;for(let S=0,M=dt[p].length;S<M;S++){const g=dt[p][S];for(w=d;w+=g,!(w&136);){if(!this._board[w])X(s,a,d,w,p);else{if(this._board[w].color===a)break;X(s,a,d,w,p,this._board[w].type,m.CAPTURE);break}if(p===$e||p===A)break}}}}if((r===void 0||r===A)&&(!f||h===this._kings[a])){if(this._castling[a]&m.KSIDE_CASTLE){const d=this._kings[a],p=d+2;!this._board[d+1]&&!this._board[p]&&!this._attacked(c,this._kings[a])&&!this._attacked(c,d+1)&&!this._attacked(c,p)&&X(s,a,this._kings[a],p,A,void 0,m.KSIDE_CASTLE)}if(this._castling[a]&m.QSIDE_CASTLE){const d=this._kings[a],p=d-2;!this._board[d-1]&&!this._board[d-2]&&!this._board[d-3]&&!this._attacked(c,this._kings[a])&&!this._attacked(c,d-1)&&!this._attacked(c,p)&&X(s,a,this._kings[a],p,A,void 0,m.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;const u=[];for(let d=0,p=s.length;d<p;d++)this._makeMove(s[d]),this._isKingAttacked(a)||u.push(s[d]),this._undoMove();return u}move(t,{strict:n=!1}={}){let o=null;if(typeof t=="string")o=this._moveFromSan(t,n);else if(typeof t=="object"){const r=this._moves();for(let s=0,a=r.length;s<a;s++)if(t.from===D(r[s].from)&&t.to===D(r[s].to)&&(!("promotion"in r[s])||t.promotion===r[s].promotion)){o=r[s];break}}if(!o)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);const i=this._makePretty(o);return this._makeMove(o),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(t){const n=this._turn,o=be(n);if(this._push(t),this._board[t.to]=this._board[t.from],delete this._board[t.from],t.flags&m.EP_CAPTURE&&(this._turn===O?delete this._board[t.to-16]:delete this._board[t.to+16]),t.promotion&&(this._board[t.to]={type:t.promotion,color:n}),this._board[t.to].type===A){if(this._kings[n]=t.to,t.flags&m.KSIDE_CASTLE){const i=t.to-1,r=t.to+1;this._board[i]=this._board[r],delete this._board[r]}else if(t.flags&m.QSIDE_CASTLE){const i=t.to+1,r=t.to-2;this._board[i]=this._board[r],delete this._board[r]}this._castling[n]=0}if(this._castling[n]){for(let i=0,r=Y[n].length;i<r;i++)if(t.from===Y[n][i].square&&this._castling[n]&Y[n][i].flag){this._castling[n]^=Y[n][i].flag;break}}if(this._castling[o]){for(let i=0,r=Y[o].length;i<r;i++)if(t.to===Y[o][i].square&&this._castling[o]&Y[o][i].flag){this._castling[o]^=Y[o][i].flag;break}}t.flags&m.BIG_PAWN?n===O?this._epSquare=t.to-16:this._epSquare=t.to+16:this._epSquare=q,t.piece===T?this._halfMoves=0:t.flags&(m.CAPTURE|m.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,n===O&&this._moveNumber++,this._turn=o}undo(){const t=this._undoMove();return t?this._makePretty(t):null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;const n=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber;const o=this._turn,i=be(o);if(this._board[n.from]=this._board[n.to],this._board[n.from].type=n.piece,delete this._board[n.to],n.captured)if(n.flags&m.EP_CAPTURE){let r;o===O?r=n.to-16:r=n.to+16,this._board[r]={type:T,color:i}}else this._board[n.to]={type:n.captured,color:i};if(n.flags&(m.KSIDE_CASTLE|m.QSIDE_CASTLE)){let r,s;n.flags&m.KSIDE_CASTLE?(r=n.to+1,s=n.to-1):(r=n.to-2,s=n.to+1),this._board[r]=this._board[s],delete this._board[s]}return n}pgn({newline:t=`
`,maxWidth:n=0}={}){const o=[];let i=!1;for(const u in this._header)o.push("["+u+' "'+this._header[u]+'"]'+t),i=!0;i&&this._history.length&&o.push(t);const r=u=>{const v=this._comments[this.fen()];if(typeof v<"u"){const d=u.length>0?" ":"";u=`${u}${d}{${v}}`}return u},s=[];for(;this._history.length>0;)s.push(this._undoMove());const a=[];let c="";for(s.length===0&&a.push(r(""));s.length>0;){c=r(c);const u=s.pop();if(!u)break;if(!this._history.length&&u.color==="b"){const v=`${this._moveNumber}. ...`;c=c?`${c} ${v}`:v}else u.color==="w"&&(c.length&&a.push(c),c=this._moveNumber+".");c=c+" "+this._moveToSan(u,this._moves({legal:!0})),this._makeMove(u)}if(c.length&&a.push(r(c)),typeof this._header.Result<"u"&&a.push(this._header.Result),n===0)return o.join("")+a.join(" ");const l=function(){return o.length>0&&o[o.length-1]===" "?(o.pop(),!0):!1},h=function(u,v){for(const d of v.split(" "))if(d){if(u+d.length>n){for(;l();)u--;o.push(t),u=0}o.push(d),u+=d.length,o.push(" "),u++}return l()&&u--,u};let f=0;for(let u=0;u<a.length;u++){if(f+a[u].length>n&&a[u].includes("{")){f=h(f,a[u]);continue}f+a[u].length>n&&u!==0?(o[o.length-1]===" "&&o.pop(),o.push(t),f=0):u!==0&&(o.push(" "),f++),o.push(a[u]),f+=a[u].length}return o.join("")}header(...t){for(let n=0;n<t.length;n+=2)typeof t[n]=="string"&&typeof t[n+1]=="string"&&(this._header[t[n]]=t[n+1]);return this._header}loadPgn(t,{strict:n=!1,newlineChar:o=`\r?
`}={}){function i(g){return g.replace(/\\/g,"\\")}function r(g){const N={},P=g.split(new RegExp(i(o)));let re="",se="";for(let k=0;k<P.length;k++){const G=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;re=P[k].replace(G,"$1"),se=P[k].replace(G,"$2"),re.trim().length>0&&(N[re]=se)}return N}t=t.trim();const a=new RegExp("^(\\[((?:"+i(o)+")|.)*\\])((?:\\s*"+i(o)+"){2}|(?:\\s*"+i(o)+")*$)").exec(t),c=a&&a.length>=2?a[1]:"";this.reset();const l=r(c);let h="";for(const g in l)g.toLowerCase()==="fen"&&(h=l[g]),this.header(g,l[g]);if(!n)h&&this.load(h,!0);else if(l.SetUp==="1"){if(!("FEN"in l))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(l.FEN,!0)}function f(g){return Array.from(g).map(function(N){return N.charCodeAt(0)<128?N.charCodeAt(0).toString(16):encodeURIComponent(N).replace(/%/g,"").toLowerCase()}).join("")}function u(g){return g.length==0?"":decodeURIComponent("%"+(g.match(/.{1,2}/g)||[]).join("%"))}const v=function(g){return g=g.replace(new RegExp(i(o),"g")," "),`{${f(g.slice(1,g.length-1))}}`},d=function(g){if(g.startsWith("{")&&g.endsWith("}"))return u(g.slice(1,g.length-1))};let p=t.replace(c,"").replace(new RegExp(`({[^}]*})+?|;([^${i(o)}]*)`,"g"),function(g,N,P){return N!==void 0?v(N):" "+v(`{${P.slice(1)}}`)}).replace(new RegExp(i(o),"g")," ");const w=/(\([^()]+\))+?/g;for(;w.test(p);)p=p.replace(w,"");p=p.replace(/\d+\.(\.\.)?/g,""),p=p.replace(/\.\.\./g,""),p=p.replace(/\$\d+/g,"");let S=p.trim().split(new RegExp(/\s+/));S=S.filter(g=>g!=="");let M="";for(let g=0;g<S.length;g++){const N=d(S[g]);if(N!==void 0){this._comments[this.fen()]=N;continue}const P=this._moveFromSan(S[g],n);if(P==null)if(ti.indexOf(S[g])>-1)M=S[g];else throw new Error(`Invalid move in PGN: ${S[g]}`);else M="",this._makeMove(P)}M&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",M)}_moveToSan(t,n){let o="";if(t.flags&m.KSIDE_CASTLE)o="O-O";else if(t.flags&m.QSIDE_CASTLE)o="O-O-O";else{if(t.piece!==T){const i=oi(t,n);o+=t.piece.toUpperCase()+i}t.flags&(m.CAPTURE|m.EP_CAPTURE)&&(t.piece===T&&(o+=D(t.from)[0]),o+="x"),o+=D(t.to),t.promotion&&(o+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?o+="#":o+="+"),this._undoMove(),o}_moveFromSan(t,n=!1){const o=Le(t);let i=ht(o),r=this._moves({legal:!0,piece:i});for(let u=0,v=r.length;u<v;u++)if(o===Le(this._moveToSan(r[u],r)))return r[u];if(n)return null;let s,a,c,l,h,f=!1;if(a=o.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],c=a[2],l=a[3],h=a[4],c.length==1&&(f=!0)):(a=o.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],c=a[2],l=a[3],h=a[4],c.length==1&&(f=!0))),i=ht(o),r=this._moves({legal:!0,piece:s||i}),!l)return null;for(let u=0,v=r.length;u<v;u++)if(c){if((!s||s.toLowerCase()==r[u].piece)&&_[c]==r[u].from&&_[l]==r[u].to&&(!h||h.toLowerCase()==r[u].promotion))return r[u];if(f){const d=D(r[u].from);if((!s||s.toLowerCase()==r[u].piece)&&_[l]==r[u].to&&(c==d[0]||c==d[1])&&(!h||h.toLowerCase()==r[u].promotion))return r[u]}}else if(o===Le(this._moveToSan(r[u],r)).replace("x",""))return r[u];return null}ascii(){let t=`   +------------------------+
`;for(let n=_.a8;n<=_.h1;n++){if(Se(n)===0&&(t+=" "+"87654321"[de(n)]+" |"),this._board[n]){const o=this._board[n].type,r=this._board[n].color===x?o.toUpperCase():o.toLowerCase();t+=" "+r+" "}else t+=" . ";n+1&136&&(t+=`|
`,n+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const n=this._moves({legal:!1});let o=0;const i=this._turn;for(let r=0,s=n.length;r<s;r++)this._makeMove(n[r]),this._isKingAttacked(i)||(t-1>0?o+=this.perft(t-1):o++),this._undoMove();return o}_makePretty(t){const{color:n,piece:o,from:i,to:r,flags:s,captured:a,promotion:c}=t;let l="";for(const v in m)m[v]&s&&(l+=jo[v]);const h=D(i),f=D(r),u={color:n,piece:o,from:h,to:f,san:this._moveToSan(t,this._moves({legal:!0})),flags:l,lan:h+f,before:this.fen(),after:""};return this._makeMove(t),u.after=this.fen(),this._undoMove(),a&&(u.captured=a),c&&(u.promotion=c,u.lan+=c),u}turn(){return this._turn}board(){const t=[];let n=[];for(let o=_.a8;o<=_.h1;o++)this._board[o]==null?n.push(null):n.push({square:D(o),type:this._board[o].type,color:this._board[o].color}),o+1&136&&(t.push(n),n=[],o+=8);return t}squareColor(t){if(t in _){const n=_[t];return(de(n)+Se(n))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const n=[],o=[];for(;this._history.length>0;)n.push(this._undoMove());for(;;){const i=n.pop();if(!i)break;t?o.push(this._makePretty(i)):o.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return o}_pruneComments(){const t=[],n={},o=i=>{i in this._comments&&(n[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(o(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),o(this.fen())}this._comments=n}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const n=this._comments[t];return delete this._comments[t],{fen:t,comment:n}})}setCastlingRights(t,n){for(const i of[A,ee])n[i]!==void 0&&(n[i]?this._castling[t]|=Ee[i]:this._castling[t]&=~Ee[i]);this._updateCastlingRights();const o=this.getCastlingRights(t);return(n[A]===void 0||n[A]===o[A])&&(n[ee]===void 0||n[ee]===o[ee])}getCastlingRights(t){return{[A]:(this._castling[t]&Ee[A])!==0,[ee]:(this._castling[t]&Ee[ee])!==0}}moveNumber(){return this._moveNumber}}function ii(e){const t=new Map;for(const n of e.moves({verbose:!0})){if(typeof n=="string")throw new Error("move is string");t.get(n.from)===void 0&&t.set(n.from,[]),t.get(n.from).push(n.to)}return t}const ri={components:{App:on,GameState:kn,Timer:An},data:()=>({game:new pt,ground:null,fenInfo:null,state:pn(),timer:hn()}),mounted(){var n;const e={autoCastle:!0,movable:{free:!1},events:{move:(o,i,r)=>{this.timer.paused=!1;const s={from:o,to:i,promotion:"q"};let a;try{a=this.game.move(s),this.state.temp.lastMove=a}catch{return}if(this.game.isCheckmate())this.right(),this.ground.explode([i]),setTimeout(()=>{this.nextFen()},500);else{if(this.game.isGameOver())throw new Error("game over but no checkmate");{this.wrong();let c=this.game.moves({verbose:!0}),l=c.filter(f=>f.captured),h;l.length?h=l[Math.floor(Math.random()*l.length)]:h=c[Math.floor(Math.random()*c.length)],this.game.move(h),this.ground.set({fen:this.game.fen()}),setTimeout(()=>{if(!this.fenInfo)throw new Error("no previous fen");this.game.load(this.fenInfo.fen),this.ground.set({fen:this.fenInfo.fen}),this.resetBoard()},1500)}}}},highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:500}},t=this.$refs.chessground;if(!(t instanceof HTMLElement))throw new Error("No board element");this.ground=Uo(t,e),this.game=new pt(((n=this.fenInfo)==null?void 0:n.fen)||void 0),this.nextFen()},methods:{skip(){this.nextFen()},lastGameResult(){return this.state.gameResults[this.state.gameResults.length-1]},right(){this.state.correct++,this.lastGameResult().attempts++,this.lastGameResult().solved=!0,this.state.temp.outcome="right",this.timer.deltas.push(3),this.timer.end.setSeconds(this.timer.end.getSeconds()+3)},wrong(){this.lastGameResult().attempts++,this.state.temp.outcome="wrong",this.timer.deltas.push(-15),this.timer.end.setSeconds(this.timer.end.getSeconds()-15)},async nextFen(){this.state.temp={};let e=await ln();this.state.gameResults.push({fen:e,timeDisplayed:new Date,solved:!1,attempts:0}),this.fenInfo=e,this.game.load(e.fen),this.resetBoard()},resetBoard(){const{game:e,ground:t}=this;if(!e||!t)throw new Error("no game");const n=ii(e);if(!this.fenInfo)throw new Error("no fen");t.set({fen:this.fenInfo.fen,orientation:this.game.turn()=="w"?"white":"black",movable:{free:!1,dests:n}})},timeUp(){console.log(this.state)}}};const si={ref:"chessground",id:"chessground-main"};function ai(e,t,n,o,i,r){const s=Je("Timer"),a=Je("GameState");return y(),ve("div",null,[E(ze,null,{default:b(()=>[E(te,{cols:"12",sm:"8",md:"6",lg:"5"},{default:b(()=>[W("div",si,null,512)]),_:1}),E(te,{cols:"12",md:"6"},{default:b(()=>[e.timer?(y(),I(s,{key:0,onTimeUp:r.timeUp,timer:e.timer,class:"mt-8"},null,8,["onTimeUp","timer"])):ue("",!0),e.state&&e.fenInfo?(y(),I(a,{key:1,onSkip:r.skip,state:e.state,puzzle:e.fenInfo,class:"mt-4"},null,8,["onSkip","state","puzzle"])):ue("",!0)]),_:1})]),_:1})])}const di=Fe(ri,[["render",ai]]);export{di as default};
